<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAG Playground</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 2em;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #content {
        width: 80%;
        max-width: 800px;
      }
      #response,
      #topics-list {
        margin-top: 1em;
        padding: 1em;
        border: 1px solid #ccc;
        min-height: 50px;
      }
      form {
        margin-bottom: 1em;
      }
      button {
        margin-left: 0.5em;
      }
      .topic-container {
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 10px;
      }
      .documents-list {
        padding-left: 20px;
      }
    </style>
  </head>
  <body>
    <div id="content">
      <h1>RAG Playground</h1>

      <h2>Topics</h2>
      <div id="topics-list"></div>
      <form id="topic-form">
        <input
          type="text"
          id="topic-name"
          placeholder="New topic name"
          required
        />
        <button type="submit">Create Topic</button>
      </form>

      <h2>Upload Documents</h2>
      <form id="upload-form">
        <select id="upload-topic-select" required></select>
        <input type="file" id="files" multiple required />
        <button type="submit">Upload</button>
      </form>

      <h2>Query a Topic</h2>
      <form id="query-form">
        <select id="query-topic-select" required></select>
        <div id="query-documents-container"></div>
        <input
          type="text"
          id="question"
          placeholder="Ask a question"
          size="50"
          required
        />
        <button type="submit">Submit</button>
      </form>

      <h2>Response:</h2>
      <div id="response"></div>
    </div>

    <script>
      const topicForm = document.getElementById('topic-form');
      const topicNameInput = document.getElementById('topic-name');
      const topicsListDiv = document.getElementById('topics-list');
      const uploadForm = document.getElementById('upload-form');
      const uploadTopicSelect = document.getElementById('upload-topic-select');
      const filesInput = document.getElementById('files');
      const queryForm = document.getElementById('query-form');
      const queryTopicSelect = document.getElementById('query-topic-select');
      const queryDocumentsContainer = document.getElementById(
        'query-documents-container',
      );
      const questionInput = document.getElementById('question');
      const responseDiv = document.getElementById('response');

      async function fetchTopics() {
        const response = await fetch('/rag/topics');
        const topics = await response.json();
        topicsListDiv.innerHTML = '';
        uploadTopicSelect.innerHTML = '';
        queryTopicSelect.innerHTML = '';

        topics.forEach((topic) => {
          const topicContainer = document.createElement('div');
          topicContainer.className = 'topic-container';

          const topicHeader = document.createElement('h3');
          topicHeader.textContent = topic;
          topicHeader.style.cursor = 'pointer';
          topicHeader.onclick = () => toggleDocuments(topic, topicContainer);
          topicContainer.appendChild(topicHeader);

          const deleteButton = document.createElement('button');
          deleteButton.textContent = 'Delete Topic';
          deleteButton.onclick = (e) => {
            e.stopPropagation();
            deleteTopic(topic);
          };
          topicHeader.appendChild(deleteButton);

          topicsListDiv.appendChild(topicContainer);

          const option1 = document.createElement('option');
          option1.value = topic;
          option1.textContent = topic;
          uploadTopicSelect.appendChild(option1);

          const option2 = document.createElement('option');
          option2.value = topic;
          option2.textContent = topic;
          queryTopicSelect.appendChild(option2);
        });
        if (topics.length > 0) {
          updateQueryDocuments(topics[0]);
        }
      }

      async function toggleDocuments(topic, container) {
        const documentsList = container.querySelector('.documents-list');
        if (documentsList) {
          documentsList.remove();
        } else {
          const response = await fetch(`/rag/topics/${topic}/documents`);
          const documents = await response.json();
          const newList = document.createElement('div');
          newList.className = 'documents-list';
          documents.forEach((doc) => {
            const docElement = document.createElement('div');
            docElement.textContent = doc;
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.onclick = (e) => {
              e.stopPropagation();
              deleteDocument(topic, doc);
            };
            docElement.appendChild(deleteButton);
            newList.appendChild(docElement);
          });
          container.appendChild(newList);
        }
      }

      async function deleteTopic(topic) {
        if (confirm(`Are you sure you want to delete the topic "${topic}"?`)) {
          await fetch(`/rag/topics/${topic}`, { method: 'DELETE' });
          fetchTopics();
        }
      }

      async function deleteDocument(topic, filename) {
        if (
          confirm(
            `Are you sure you want to delete the document "${filename}" from "${topic}"?`,
          )
        ) {
          await fetch(`/rag/topics/${topic}/documents/${filename}`, {
            method: 'DELETE',
          });
          fetchTopics();
        }
      }

      topicForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const topicName = topicNameInput.value;
        await fetch('/rag/topics', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topic: topicName }),
        });
        topicNameInput.value = '';
        fetchTopics();
      });

      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const topic = uploadTopicSelect.value;
        const formData = new FormData();
        for (const file of filesInput.files) {
          formData.append('files', file);
        }

        responseDiv.textContent = 'Uploading and indexing...';
        await fetch(`/rag/topics/${topic}/documents`, {
          method: 'POST',
          body: formData,
        });
        responseDiv.textContent = 'Upload complete.';
        filesInput.value = '';
        fetchTopics();
      });

      queryTopicSelect.addEventListener('change', (e) => {
        updateQueryDocuments(e.target.value);
      });

      async function updateQueryDocuments(topic) {
        const response = await fetch(`/rag/topics/${topic}/documents`);
        const documents = await response.json();
        queryDocumentsContainer.innerHTML = '';
        documents.forEach((doc) => {
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.name = 'documentsToUse';
          checkbox.value = doc;
          checkbox.id = `doc-${doc}`;
          const label = document.createElement('label');
          label.htmlFor = `doc-${doc}`;
          label.textContent = doc;
          const br = document.createElement('br');
          queryDocumentsContainer.appendChild(checkbox);
          queryDocumentsContainer.appendChild(label);
          queryDocumentsContainer.appendChild(br);
        });
      }

      queryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const topic = queryTopicSelect.value;
        const question = questionInput.value;
        const selectedDocuments = Array.from(
          queryDocumentsContainer.querySelectorAll(
            'input[name="documentsToUse"]:checked',
          ),
        ).map((cb) => cb.value);

        let url = `/rag/topics/${topic}/query?question=${encodeURIComponent(
          question,
        )}`;
        if (selectedDocuments.length > 0) {
          url += `&${selectedDocuments
            .map((d) => `documentsToUse=${encodeURIComponent(d)}`)
            .join('&')}`;
        }

        responseDiv.textContent = 'Loading...';
        const response = await fetch(url);
        const text = await response.text();
        responseDiv.textContent = text;
      });

      fetchTopics();
    </script>
  </body>
</html>
